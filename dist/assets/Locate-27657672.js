import{m as $,e as o,y as i,n as m,t as O}from"./cast-34ff1fab.js";import"./typedArrayUtil-6bfe4dae.js";import"./ensureType-abaf235a.js";import{e as w,M as S,n as g}from"./jsxFactory-5e151729.js";import"./intl-1561e875.js";import{k as N}from"./PopupTemplate-8759f34d.js";import{a as u}from"./Error-e5869661.js";import{t as H}from"./actions-6d573c02.js";import{a as x}from"./assets-544006ef.js";import v from"./Graphic-ba3a92c9.js";import{n as P}from"./Evented-fac53f7f.js";import{n as k}from"./symbols-0eeb49ca.js";import{l as A,j as I,g as U}from"./geolocationUtils-f96ff71d.js";import{e as G,a as W,t as z}from"./GoTo-bb83f615.js";import{s as j}from"./locale-30120714.js";import{u as F}from"./messages-fe8e2c1f.js";import"./string-46813dd9.js";import"./nextTick-3ee5a785.js";import"./promiseUtils-281d25c9.js";import"./Promise-19e65545.js";import"./reactiveUtils-aec98ee9.js";import"./uuid-73213768.js";import"./request-c6faf466.js";import"./preload-helper-596b5639.js";import"./number-4b1bfb24.js";import"./jsonMap-92eea954.js";import"./Clonable-a26a28b0.js";import"./Collection-3317d203.js";import"./SimpleObservable-f97014ec.js";import"./Extent-b8913cd1.js";import"./fieldUtils-c253753a.js";import"./arcadeOnDemand-c5034a8b.js";import"./geometry-1b3a0099.js";import"./Polyline-7684a66d.js";import"./typeUtils-0cf27003.js";import"./enumeration-e40d8895.js";import"./Identifiable-016ad07d.js";import"./jsonUtils-eb956695.js";import"./CIMSymbol-6c8aee70.js";import"./Symbol-8a110cc7.js";import"./Color-0f9fdd46.js";import"./colorUtils-639f4d25.js";import"./mathUtils-daf59e84.js";import"./common-701a4199.js";import"./screenUtils-7afeb41c.js";import"./opacityUtils-ea6b845d.js";import"./SimpleFillSymbol-80498a78.js";import"./aaBoundingBox-77ee83e3.js";import"./persistableUrlUtils-3427b748.js";import"./collectionUtils-23cca63a.js";import"./Portal-d13c5d2a.js";import"./Loadable-3c0fb2d0.js";import"./PortalGroup-506cda94.js";import"./PortalUser-12cb329a.js";import"./project-8b344e00.js";import"./utils-a49efee8.js";const R=2500;let n=class extends G(P.EventedMixin($)){constructor(){super(...arguments),this._geolocationUsable=!0,this._iconPath=x("esri/images/support/sdk_gps_location.png"),this.geolocationOptions=null,this.goToLocationEnabled=!0,this.graphic=new v({symbol:new k({url:this._iconPath,width:21,height:21})}),this.scale=null,this.useHeadingEnabled=!0,this.view=null}initialize(){A()||(this._geolocationUsable=!1)}destroy(){this._clear(),this.view=null}_clear(){this.view&&this.view.graphics.remove(this.graphic)}_getScaleWithinConstraints(t,e){if(!e)return t;if(e.type==="2d"){const{effectiveMaxScale:a,effectiveMinScale:s}=e.constraints;return Math.min(s,Math.max(a,t))}return t}_getScale(t){const{scale:e}=this,a=typeof e=="number"?e:R;return this._getScaleWithinConstraints(a,t)}_getHeading(t,e){const a=e&&e.spatialReference,s=a&&(a.isWebMercator||a.isGeographic),l=t.coords&&t.coords.heading;if(!(!s||typeof l!="number"||isNaN(l)||l<0||l>360))return l}_addHeading(t){const{heading:e,target:a,view:s}=t;s&&typeof e=="number"&&!isNaN(e)&&(s.type!=="3d"?s.type==="2d"&&(a.rotation=360-e):a.heading=e)}_animatePoint(t,e,a,s){const{view:l}=this;if(!this.goToLocationEnabled||!l)return Promise.resolve(e);const h=this.useHeadingEnabled?this._getHeading(e,l):void 0,d={target:t,scale:a};return this._addHeading({heading:h,target:d,view:l}),this.callGoTo({target:d,options:s}).then(()=>e)}async _setPosition(t,e){try{const a=await I({position:t,view:this.view},e),{graphic:s}=this,{timestamp:l}=t,{coords:h}=t,{accuracy:d,altitude:y,altitudeAccuracy:f,heading:_,latitude:M,longitude:E,speed:L}=h,C={timestamp:l,accuracy:d,altitude:y,altitudeAccuracy:f,heading:_,latitude:M,longitude:E,speed:L};s&&(s.geometry=a,s.attributes=C);const T=this._getScale(this.view);return this._animatePoint(a,t,T,e)}catch(a){throw new u("positioning:invalid-point","Cannot position invalid point",{error:a})}}};o([i()],n.prototype,"_geolocationUsable",void 0),o([i()],n.prototype,"geolocationOptions",void 0),o([i()],n.prototype,"goToLocationEnabled",void 0),o([i({type:v,nonNullable:!0})],n.prototype,"graphic",void 0),o([i()],n.prototype,"scale",void 0),o([i()],n.prototype,"useHeadingEnabled",void 0),o([i()],n.prototype,"view",void 0),n=o([m("esri.widgets.support.GeolocationPositioning")],n);const V=n;async function q(){const t=await F("esri/widgets/Locate/t9n/Locate");return new N({title:t.currentLocation,fieldInfos:[{fieldName:"timestamp",label:t.timestamp,format:{dateFormat:"short-date-short-time"}},{fieldName:"latitude",label:t.latitude,format:{places:4,digitSeparator:!0}},{fieldName:"longitude",label:t.longitude,format:{places:4,digitSeparator:!0}},{fieldName:"accuracy",label:t.accuracy,format:{places:0,digitSeparator:!0}},{fieldName:"altitude",label:t.altitude,format:{places:0,digitSeparator:!0}},{fieldName:"altitudeAccuracy",label:t.altitudeAccuracy,format:{places:0,digitSeparator:!0}},{fieldName:"heading",label:t.heading,format:{places:0,digitSeparator:!0}},{fieldName:"speed",label:t.speed,format:{places:0,digitSeparator:!0}}],actions:[H.clone()],content:[{type:"fields"}]})}let c=class extends V{constructor(t){super(t),this._locateController=null,this._handles=new O,this.popupEnabled=!0,this.locate=this.locate.bind(this)}initialize(){this._handles.add([j(()=>{var s;const{graphic:t,view:e}=this;((s=e==null?void 0:e.graphics)==null?void 0:s.includes(t))&&this._updatePopupTemplate(t)})])}destroy(){this.cancelLocate(),this._handles.destroy(),this._handles=null}get state(){return this._geolocationUsable?this.get("view.ready")?this._locateController?"locating":"ready":"disabled":"feature-unsupported"}async locate(){if(this.cancelLocate(),this.state==="disabled")throw new u("locate:disabled-state","Cannot locate when disabled.");if(this.state==="feature-unsupported")throw new u("locate:feature-unsupported-state","Cannot locate in unsecure domain.");const t=new AbortController;this._locateController=t;try{let e=await U(this.geolocationOptions);return e=await this._setPosition(e,{signal:t.signal}),this._locateController!==t?null:(this.graphic&&(this.graphic=this.graphic.clone(),await this._updatePopupTemplate(this.graphic),this.view.graphics.push(this.graphic)),this.emit("locate",{position:e}),this._locateController=null,e)}catch(e){throw this._locateController=null,this.emit("locate-error",{error:e}),e}}cancelLocate(){this._clear(),this._locateController&&this._locateController.abort(),this._locateController=null}async _updatePopupTemplate(t){if(!this.popupEnabled)return;const e=await q(),a=t!==this.graphic;this.destroyed||a||(t.popupTemplate=e)}};o([i()],c.prototype,"_locateController",void 0),o([i()],c.prototype,"popupEnabled",void 0),o([i({readOnly:!0})],c.prototype,"state",null),o([i()],c.prototype,"locate",null),o([i()],c.prototype,"cancelLocate",null),c=o([m("esri.widgets.Locate.LocateViewModel")],c);const b=c,p={base:"esri-locate esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-icon",locate:"esri-icon-locate",loading:"esri-icon-loading-indicator",rotating:"esri-rotating",widgetIcon:"esri-icon-north-navigation",disabled:"esri-disabled",hidden:"esri-hidden"};let r=class extends S{constructor(t,e){super(t,e),this.iconClass=p.widgetIcon,this.messages=null,this.messagesCommon=null,this.viewModel=new b}get geolocationOptions(){return this.viewModel.geolocationOptions}set geolocationOptions(t){this.viewModel.geolocationOptions=t}get goToLocationEnabled(){return this.viewModel.goToLocationEnabled}set goToLocationEnabled(t){this.viewModel.goToLocationEnabled=t}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(t){this.viewModel.goToOverride=t}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get label(){var t;return((t=this.messages)==null?void 0:t.widgetLabel)??""}set label(t){this._overrideIfSome("label",t)}get popupEnabled(){return this.viewModel.popupEnabled}set popupEnabled(t){this.viewModel.popupEnabled=t}get scale(){return this.viewModel.scale}set scale(t){this.viewModel.scale=t}get useHeadingEnabled(){return this.viewModel.useHeadingEnabled}set useHeadingEnabled(t){this.viewModel.useHeadingEnabled=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}cancelLocate(){this.viewModel.cancelLocate()}locate(){return this.viewModel.locate()}render(){const t=this.get("viewModel.state"),e=t==="locating",a={[p.disabled]:t==="disabled",[p.hidden]:t==="feature-unsupported"},s={[p.loading]:e,[p.rotating]:e,[p.locate]:!e},l=t==="locating"?this.messagesCommon.cancel:this.messages.title;return g("div",{bind:this,class:this.classes(p.base,a),hidden:t==="feature-unsupported",onclick:this._locate,onkeydown:this._locate,role:"button",tabIndex:0,"aria-label":l,title:l},g("span",{"aria-hidden":"true",class:this.classes(p.icon,s)}),g("span",{class:p.text},this.messages.title))}_locate(){const{viewModel:t}=this;t.state==="locating"?t.cancelLocate():t.locate()}};o([i()],r.prototype,"geolocationOptions",null),o([i()],r.prototype,"goToLocationEnabled",null),o([i()],r.prototype,"goToOverride",null),o([i()],r.prototype,"graphic",null),o([i()],r.prototype,"iconClass",void 0),o([i()],r.prototype,"label",null),o([i(),w("esri/widgets/Locate/t9n/Locate")],r.prototype,"messages",void 0),o([i(),w("esri/t9n/common")],r.prototype,"messagesCommon",void 0),o([i()],r.prototype,"popupEnabled",null),o([i()],r.prototype,"scale",null),o([i()],r.prototype,"useHeadingEnabled",null),o([i()],r.prototype,"view",null),o([i({type:b}),W(["locate","locate-error"])],r.prototype,"viewModel",void 0),o([z()],r.prototype,"_locate",null),r=o([m("esri.widgets.Locate")],r);const Jt=r;export{Jt as default};
